(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();class z{constructor(e){this.canvas=e,this.ctx=e.getContext("2d"),this.tileSize=32,this.effects=[],this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight}clear(){this.ctx.fillStyle="#111",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}drawMap(e,t,s){this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let i=0;i<e.height;i++)for(let r=0;r<e.width;r++){const o=`${r},${i}`,l=t.has(o);if(!s.has(o)&&!l)continue;const c=e.tiles[i][r],n=r*this.tileSize,u=i*this.tileSize;this.ctx.globalAlpha=l?1:.3,this.ctx.font=`${this.tileSize}px monospace`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",c==="wall"?(this.ctx.fillStyle="#444",this.ctx.fillRect(n,u,this.tileSize,this.tileSize),this.ctx.fillStyle="#666",this.ctx.fillText("üß±",n+this.tileSize/2,u+this.tileSize/2)):c==="floor"?(this.ctx.fillStyle="#222",this.ctx.fillRect(n,u,this.tileSize,this.tileSize),this.ctx.fillStyle="#333",this.ctx.fillText("¬∑",n+this.tileSize/2,u+this.tileSize/2)):c==="stairs"&&(this.ctx.fillStyle="#222",this.ctx.fillRect(n,u,this.tileSize,this.tileSize),this.ctx.fillStyle="#ffff00",this.ctx.fillText("ü™ú",n+this.tileSize/2,u+this.tileSize/2))}this.ctx.globalAlpha=1}drawEntity(e,t){if(!t){console.error("visibleTiles is undefined in drawEntity");return}if(!t.has(`${e.x},${e.y}`))return;const s=this.tileSize;this.ctx.font=`${s*.8}px sans-serif`,this.ctx.textAlign="center",this.ctx.textBaseline="middle";let i=e.char;e.constructor.name==="Player"?i="üßô‚Äç‚ôÇÔ∏è":e.constructor.name==="Potion"?i="üç∑":e.constructor.name==="Weapon"?i="üó°Ô∏è":e.constructor.name==="Armor"?i="üõ°Ô∏è":e.type==="bat"?i="ü¶á":e.type==="orc"?i="üëπ":e.type==="shaman"?i="üë∫":e.type==="goblin"?i="üëø":e.type==="skeleton"?i="üíÄ":e.type==="ogre"&&(i="üëπ"),this.ctx.fillStyle="rgba(0,0,0,0.5)",this.ctx.fillText(i,e.x*s+s/2+2,e.y*s+s/2+2),this.ctx.fillStyle=e.color||"#fff",this.ctx.fillText(i,e.x*s+s/2,e.y*s+s/2)}triggerEffect(e,t,s){this.effects.push({x:e,y:t,type:s,life:20})}drawEffects(){for(let e=this.effects.length-1;e>=0;e--){const t=this.effects[e],s=t.x*this.tileSize,i=t.y*this.tileSize;t.type==="hit"&&(this.ctx.fillStyle=`rgba(255, 0, 0, ${t.life/20})`,this.ctx.fillRect(s,i,this.tileSize,this.tileSize)),t.life--,t.life<=0&&this.effects.splice(e,1)}}}class R{constructor(e,t){this.width=e,this.height=t,this.rooms=[]}generate(){return Math.random()<.5?this.generateDungeon():this.generateCaves()}generateCaves(){const e={width:this.width,height:this.height,tiles:[],rooms:[]};for(let i=0;i<this.height;i++){const r=[];for(let o=0;o<this.width;o++)r.push(Math.random()<.45?"wall":"floor");e.tiles.push(r)}for(let i=0;i<5;i++){const r=JSON.parse(JSON.stringify(e.tiles));for(let o=1;o<this.height-1;o++)for(let l=1;l<this.width-1;l++){let a=0;for(let c=-1;c<=1;c++)for(let n=-1;n<=1;n++)n===0&&c===0||e.tiles[o+c][l+n]==="wall"&&a++;a>4?r[o][l]="wall":a<4&&(r[o][l]="floor")}e.tiles=r}for(let i=0;i<this.height;i++)e.tiles[i][0]="wall",e.tiles[i][this.width-1]="wall";for(let i=0;i<this.width;i++)e.tiles[0][i]="wall",e.tiles[this.height-1][i]="wall";let t,s;do t=Math.floor(Math.random()*this.width),s=Math.floor(Math.random()*this.height);while(e.tiles[s][t]==="wall");return e.tiles[s][t]="stairs",e}generateDungeon(){const e={width:this.width,height:this.height,tiles:[],rooms:[]};for(let r=0;r<this.height;r++){const o=[];for(let l=0;l<this.width;l++)o.push("wall");e.tiles.push(o)}this.rooms=[];const t=10,s=6,i=12;for(let r=0;r<t;r++){const o=Math.floor(Math.random()*(i-s+1))+s,l=Math.floor(Math.random()*(i-s+1))+s,a=Math.floor(Math.random()*(this.width-o-1))+1,c=Math.floor(Math.random()*(this.height-l-1))+1,n={x:a,y:c,w:o,h:l};let u=!1;for(const p of this.rooms)if(n.x<=p.x+p.w&&n.x+n.w>=p.x&&n.y<=p.y+p.h&&n.y+n.h>=p.y){u=!0;break}if(!u){if(this.createRoom(n,e),this.rooms.length>0){const p=this.rooms[this.rooms.length-1],f=this.getCenter(n),m=this.getCenter(p);Math.random()<.5?(this.createHCorridor(m.x,f.x,m.y,e),this.createVCorridor(m.y,f.y,f.x,e)):(this.createVCorridor(m.y,f.y,m.x,e),this.createHCorridor(m.x,f.x,f.y,e))}this.rooms.push(n),e.rooms.push(n)}}if(this.placeDoors(e),this.rooms.length>0){const r=this.rooms[this.rooms.length-1],o=this.getCenter(r);e.tiles[o.y][o.x]="stairs"}return e}createRoom(e,t){for(let s=e.y;s<e.y+e.h;s++)for(let i=e.x;i<e.x+e.w;i++)t.tiles[s][i]="floor"}createHCorridor(e,t,s,i){for(let r=Math.min(e,t);r<=Math.max(e,t);r++)i.tiles[s][r],i.tiles[s][r]="floor"}createVCorridor(e,t,s,i){for(let r=Math.min(e,t);r<=Math.max(e,t);r++)i.tiles[r][s],i.tiles[r][s]="floor"}placeDoors(e){for(const t of e.rooms){for(let s=t.x;s<t.x+t.w;s++)e.tiles[t.y-1]&&e.tiles[t.y-1][s]==="floor"&&Math.random()<.3&&(e.tiles[t.y-1][s]="door_closed"),e.tiles[t.y+t.h]&&e.tiles[t.y+t.h][s]==="floor"&&Math.random()<.3&&(e.tiles[t.y+t.h][s]="door_closed");for(let s=t.y;s<t.y+t.h;s++)e.tiles[s][t.x-1]==="floor"&&Math.random()<.3&&(e.tiles[s][t.x-1]="door_closed"),e.tiles[s][t.x+t.w]==="floor"&&Math.random()<.3&&(e.tiles[s][t.x+t.w]="door_closed")}}getCenter(e){return{x:Math.floor(e.x+e.w/2),y:Math.floor(e.y+e.h/2)}}}class C{constructor(e,t,s,i){this.x=e,this.y=t,this.char=s,this.color=i}move(e,t,s){const i=this.x+e,r=this.y+t;return i>=0&&i<s.width&&r>=0&&r<s.height&&s.tiles[r][i]!=="wall"?(this.x=i,this.y=r,!0):!1}}class b extends C{constructor(e,t,s="warrior"){super(e,t,"@","#fff"),this.classType=s,this.hp=100,this.maxHp=100,this.level=1,this.xp=0,this.xpToNextLevel=100,this.inventory=[],this.equipment={weapon:null,armor:null},this.classType==="warrior"?(this.maxHp+=20,this.hp=this.maxHp):this.classType==="mage"&&(this.maxHp-=20,this.hp=this.maxHp)}gainXp(e){this.xp+=e,this.xp>=this.xpToNextLevel&&this.levelUp()}levelUp(){this.level++,this.xp-=this.xpToNextLevel,this.xpToNextLevel=Math.floor(this.xpToNextLevel*1.5),this.maxHp+=20,this.hp=this.maxHp}equip(e){return e.slot==="weapon"?(this.equipment.weapon&&this.inventory.push(this.equipment.weapon),this.equipment.weapon=e,!0):e.slot==="armor"?(this.equipment.armor&&this.inventory.push(this.equipment.armor),this.equipment.armor=e,!0):!1}getAttack(){let e=5+this.level*2;return this.equipment.weapon&&(e+=this.equipment.weapon.bonus),e}getDefense(){let e=0;return this.equipment.armor&&(e+=this.equipment.armor.bonus),e}}class g extends C{constructor(e,t,s="goblin"){let i="g",r="#ff4444",o=20;s==="bat"?(i="b",r="#a8a8a8",o=10):s==="orc"?(i="O",r="#00aa00",o=40):s==="shaman"?(i="S",r="#aa00aa",o=15):s==="skeleton"?(i="üíÄ",r="#dddddd",o=12):s==="ogre"?(i="üëπ",r="#006600",o=60):s==="dragon"&&(i="üêâ",r="#ff0000",o=150),super(e,t,i,r),this.type=s,this.hp=o}getAttack(){return this.type==="bat"?2:this.type==="goblin"?5:this.type==="shaman"?4:this.type==="orc"?8:this.type==="skeleton"?4:this.type==="ogre"?12:this.type==="dragon"?20:3}getDefense(){return this.type==="bat"?0:this.type==="goblin"||this.type==="shaman"?1:this.type==="orc"?3:this.type==="skeleton"?1:this.type==="ogre"?4:this.type==="dragon"?8:0}takeTurn(e,t,s){const i=e.x-this.x,r=e.y-this.y,o=Math.abs(i)+Math.abs(r);if(this.type==="bat")for(let l=0;l<2;l++){if(Math.random()<.3){const a=[[0,1],[0,-1],[1,0],[-1,0]],c=a[Math.floor(Math.random()*a.length)];this.tryMove(c[0],c[1],t,e,s)}else this.moveTowards(e,t,s);if(Math.abs(e.x-this.x)+Math.abs(e.y-this.y)<=1)break}else if(this.type==="shaman")if(o<=4)if(o<=2){let l=0,a=0;i!==0&&(l=i>0?-1:1),r!==0&&(a=r>0?-1:1),this.tryMove(l,a,t,e,null)}else s&&s("magic");else this.moveTowards(e,t,s);else this.type==="dragon"?(i===0||r===0)&&o<=5?s&&s("firebreath"):this.moveTowards(e,t,s):this.type==="ogre"?this.moveTowards(e,t,s):this.moveTowards(e,t,s)}moveTowards(e,t,s){const i=e.x-this.x,r=e.y-this.y;let o=0,l=0;Math.abs(i)>Math.abs(r)?o=i>0?1:-1:l=r>0?1:-1,this.tryMove(o,l,t,e,s)}tryMove(e,t,s,i,r){const o=this.x+e,l=this.y+t;if(o===i.x&&l===i.y){r&&r("melee");return}this.move(e,t,s)}}class x extends C{constructor(e,t,s,i,r){super(e,t,i,r),this.name=s}}class T extends x{constructor(e,t){super(e,t,"Health Potion","!","#ff00ff"),this.healAmount=20}use(e){return e.hp>=e.maxHp?!1:(e.hp=Math.min(e.hp+this.healAmount,e.maxHp),!0)}}class A extends x{constructor(e,t,s,i,r){super(e,t,s,"üìú",i),this.effectType=r}use(e,t){return this.activate(e,t)}activate(e,t){return!1}}class S extends A{constructor(e,t){super(e,t,"Scroll of Fireball","#ff4400","fireball"),this.damage=20,this.range=5}activate(e,t){let s=0;return t.enemies.forEach(i=>{Math.abs(i.x-e.x)+Math.abs(i.y-e.y)<=this.range&&(i.hp-=this.damage,t.log(`Fireball burns ${i.type} for ${this.damage} dmg!`,"combat"),t.renderer.triggerEffect(i.x,i.y,"hit"),s++)}),s>0?(t.enemies=t.enemies.filter(i=>i.hp<=0?(t.log(`${i.type} is incinerated! +${i.xpValue||10} XP`,"success"),e.gainXp(i.xpValue||10),!1):!0),!0):(t.log("No enemies in range to burn.","warning"),!1)}}class E extends A{constructor(e,t){super(e,t,"Scroll of Teleport","#00ffff","teleport")}activate(e,t){let s,i,r=0;do s=Math.floor(Math.random()*t.map.width),i=Math.floor(Math.random()*t.map.height),r++;while((t.map.tiles[i][s]==="wall"||s===e.x&&i===e.y)&&r<100);return t.map.tiles[i][s]!=="wall"?(e.x=s,e.y=i,t.log("You teleport to a new location!","magic"),t.updateFOV(),!0):!1}}class q extends x{constructor(e,t){super(e,t,"Amulet of Yendor","üìø","#ffd700")}use(e,t){return!0}}class O extends x{constructor(e,t){super(e,t,"Golden Key","üîë","#ffd700")}use(e,t){return t.log("This key can open locked doors.","info"),!1}}class G extends x{constructor(e,t,s,i,r,o,l){super(e,t,s,i,r),this.slot=o,this.bonus=l}use(e){return e.equip(this)}}class k extends G{constructor(e,t,s=1){const i=[{name:"Rusty Dagger",bonus:2,color:"#888"},{name:"Iron Sword",bonus:5,color:"#ddd"},{name:"Steel Axe",bonus:8,color:"#aaf"},{name:"Mithril Blade",bonus:12,color:"#0ff"}],r=i[Math.min(s,i.length)-1];super(e,t,r.name,"üó°Ô∏è",r.color,"weapon",r.bonus)}}class I extends G{constructor(e,t,s=1){const i=[{name:"Tattered Robe",bonus:1,color:"#a88"},{name:"Leather Armor",bonus:3,color:"#a52"},{name:"Chainmail",bonus:6,color:"#aaa"},{name:"Plate Armor",bonus:10,color:"#eee"}],r=i[Math.min(s,i.length)-1];super(e,t,r.name,"üõ°Ô∏è",r.color,"armor",r.bonus)}}class L{constructor(e){this.map=e,this.visible=new Set}compute(e,t,s){this.visible.clear(),this.visible.add(`${e},${t}`);for(let i=0;i<8;i++)this.castLight(e,t,1,1,0,s,this.multipliers[0][i],this.multipliers[1][i],this.multipliers[2][i],this.multipliers[3][i]);return this.visible}castLight(e,t,s,i,r,o,l,a,c,n){if(i<r)return;let u=o*o;for(let p=s;p<=o;p++){let f=-p-1,m=-p,w=!1,v=0;for(;f<=0;){f++;let d=e+f*l+m*a,y=t+f*c+m*n,$=(f-.5)/(m+.5),M=(f+.5)/(m-.5);if(!(i<M)){if(r>$)break;if(f*f+m*m<u&&d>=0&&d<this.map.width&&y>=0&&y<this.map.height&&this.visible.add(`${d},${y}`),w)if(this.isBlocked(d,y)){v=M;continue}else w=!1,i=v;else this.isBlocked(d,y)&&p<o&&(w=!0,this.castLight(e,t,p+1,i,$,o,l,a,c,n),v=M)}}if(w)break}}isBlocked(e,t){return e<0||e>=this.map.width||t<0||t>=this.map.height?!0:this.map.tiles[t][e]==="wall"}multipliers=[[1,0,0,-1,-1,0,0,1],[0,1,-1,0,0,-1,1,0],[0,1,1,0,0,-1,-1,0],[1,0,0,1,-1,0,0,-1]]}class P{constructor(){this.ctx=new(window.AudioContext||window.webkitAudioContext)}playTone(e,t,s){this.ctx.state==="suspended"&&this.ctx.resume();const i=this.ctx.createOscillator(),r=this.ctx.createGain();i.type=t,i.frequency.setValueAtTime(e,this.ctx.currentTime),r.gain.setValueAtTime(.1,this.ctx.currentTime),r.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+s),i.connect(r),r.connect(this.ctx.destination),i.start(),i.stop(this.ctx.currentTime+s)}playAttack(){this.playTone(150,"square",.1)}playHit(){this.playTone(100,"sawtooth",.1)}playPickup(){this.playTone(600,"sine",.1)}playLevelUp(){this.playTone(400,"sine",.1),setTimeout(()=>this.playTone(600,"sine",.1),100),setTimeout(()=>this.playTone(800,"sine",.2),200)}playFootstep(){this.playTone(100,"triangle",.05)}playMiss(){this.playTone(800,"sawtooth",.05)}}class H{constructor(){this.command=null}handleKey(e){return this.command=null,e.key==="ArrowUp"||e.key==="w"?{type:"move",dx:0,dy:-1}:e.key==="ArrowDown"||e.key==="s"?{type:"move",dx:0,dy:1}:e.key==="ArrowLeft"||e.key==="a"?{type:"move",dx:-1,dy:0}:e.key==="ArrowRight"||e.key==="d"?{type:"move",dx:1,dy:0}:e.key==="Enter"||e.key===" "?{type:"interact"}:e.key==="g"?{type:"pickup"}:e.key==="i"?{type:"inventory"}:e.key==="r"?{type:"restart"}:null}}class B{constructor(e){this.game=e}resolveAttack(e,t){if(Math.random()>.8)return{hit:!1,damage:0,killed:!1,attacker:e,defender:t};const s=e.getAttack(),i=t.getDefense?t.getDefense():0,r=Math.max(1,s-i);return t.hp-=r,{hit:!0,damage:r,killed:t.hp<=0,attacker:e,defender:t}}}class N{constructor(e){this.renderer=new z(e),this.audio=new P,this.inputHandler=new H,this.combatSystem=new B(this),this.mapGenerator=new R(50,30),this.map=null,this.player=null,this.enemies=[],this.items=[],this.isPlayerTurn=!0,this.fov=null,this.visibleTiles=new Set,this.exploredTiles=new Set,this.fovRadius=8,this.gameState="PLAYING",this.createSaveControls()}createSaveControls(){const e=document.createElement("div");e.style.position="absolute",e.style.top="10px",e.style.right="10px",e.style.zIndex="100";const t=document.createElement("button");t.innerText="Save",t.onclick=()=>this.saveGame();const s=document.createElement("button");s.innerText="Load",s.onclick=()=>this.loadGame(),e.appendChild(t),e.appendChild(s),document.body.appendChild(e)}saveGame(){const e={map:this.map,player:{x:this.player.x,y:this.player.y,hp:this.player.hp,maxHp:this.player.maxHp,level:this.player.level,xp:this.player.xp,xpToNextLevel:this.player.xpToNextLevel,inventory:this.player.inventory,equipment:this.player.equipment},enemies:this.enemies.map(t=>({x:t.x,y:t.y,hp:t.hp,type:t.type})),items:this.items,level:this.player.level,exploredTiles:Array.from(this.exploredTiles)};localStorage.setItem("roguelike_save",JSON.stringify(e)),this.log("Game Saved!","success")}loadGame(){const e=localStorage.getItem("roguelike_save");if(!e){this.log("No save game found.","warning");return}const t=JSON.parse(e);this.map=t.map,this.mapGenerator.width=this.map.width,this.mapGenerator.height=this.map.height,this.player=new b(t.player.x,t.player.y),Object.assign(this.player,t.player),this.player.inventory=t.player.inventory.map(s=>this.hydrateItem(s)),this.player.equipment.weapon&&(this.player.equipment.weapon=this.hydrateItem(this.player.equipment.weapon)),this.player.equipment.armor&&(this.player.equipment.armor=this.hydrateItem(this.player.equipment.armor)),this.enemies=t.enemies.map(s=>{const i=new g(s.x,s.y,s.type);return i.hp=s.hp,i}),this.items=t.items.map(s=>this.hydrateItem(s)),this.exploredTiles=new Set(t.exploredTiles),this.fov=new L(this.map),this.updateFOV(),this.log("Game Loaded!","success"),this.update()}hydrateItem(e){if(!e)return null;if(e.slot){if(e.slot==="weapon")return new k(e.x,e.y,e.bonus<5?1:e.bonus<8?2:3);if(e.slot==="armor")return new I(e.x,e.y,e.bonus<3?1:e.bonus<6?2:3)}if(e.name.includes("Potion"))return new T(e.x,e.y);if(e.name.includes("Fireball"))return new S(e.x,e.y);if(e.name.includes("Teleport"))return new E(e.x,e.y);this.update(),this.loop()}init(){try{console.log("Game.init() called");const e=document.getElementById("class-selection"),t=document.querySelectorAll(".class-card");if(console.log("Found selectionDiv:",e),console.log("Found cards:",t.length),!e){console.error("Critical Error: class-selection element not found!");return}t.forEach(r=>{r.onclick=()=>{try{console.log("Card clicked:",r.getAttribute("data-class"));const o=r.getAttribute("data-class");e&&(e.style.display="none"),this.startGame(o)}catch(o){console.error("Error handling card click:",o),alert("Error starting game: "+o.message)}}});const s=document.getElementById("restart-btn-go"),i=document.getElementById("restart-btn-vic");s&&(s.onclick=()=>this.restart()),i&&(i.onclick=()=>this.restart())}catch(e){console.error("Error in Game.init:",e)}}startGame(e){try{console.log("Starting game with class:",e),this.playerClass=e,this.generateLevel(),this.update(),this.loop()}catch(t){console.error("Error in startGame:",t),alert("Critical Game Error: "+t.message)}}generateLevel(){if(this.map=this.mapGenerator.generate(),this.fov=new L(this.map),this.exploredTiles.clear(),this.map.rooms&&this.map.rooms.length>0){const e=this.map.rooms[0],t=this.mapGenerator.getCenter(e);if(this.player?(this.player.x=t.x,this.player.y=t.y):this.player=new b(t.x,t.y,this.playerClass),this.enemies=[],this.items=[],this.player.level===10){const s=this.mapGenerator.getCenter(this.map.rooms[this.map.rooms.length-1]);this.enemies.push(new g(s.x,s.y,"dragon"));const i=this.mapGenerator.getCenter(this.map.rooms[Math.floor(this.map.rooms.length/2)]);this.items.push(new q(i.x,i.y)),this.log("You feel an ominous presence... The Dragon awaits!","important")}else{for(let s=1;s<this.map.rooms.length;s++){const i=this.map.rooms[s],r=this.mapGenerator.getCenter(i);if(Math.random()<.7){const o=Math.random();let l="goblin";o<.2?l="bat":o<.4?l="shaman":o<.5?l="orc":o<.65?l="skeleton":o<.7&&(l="ogre"),this.enemies.push(new g(r.x,r.y,l))}if(Math.random()<.6){const o=Math.floor(Math.random()*i.w)+i.x,l=Math.floor(Math.random()*i.h)+i.y;if(this.map.tiles[l][o]==="floor"){const a=Math.random();if(a<.4)this.items.push(new T(o,l));else if(a<.5)this.items.push(new S(o,l));else if(a<.6)this.items.push(new E(o,l));else if(a<.8){const c=Math.min(4,Math.floor(this.player.level/2)+1);this.items.push(new k(o,l,c))}else{const c=Math.min(4,Math.floor(this.player.level/2)+1);this.items.push(new I(o,l,c))}}}if(Math.random()<.2){const o=Math.floor(Math.random()*i.w)+i.x,l=Math.floor(Math.random()*i.h)+i.y;this.map.tiles[l][o]==="floor"&&this.items.push(new O(o,l))}}for(;this.enemies.length<3;){let s,i;do s=Math.floor(Math.random()*this.map.width),i=Math.floor(Math.random()*this.map.height);while(this.map.tiles[i][s]==="wall");this.enemies.push(new g(s,i))}}}else{let e,t;do e=Math.floor(Math.random()*this.map.width),t=Math.floor(Math.random()*this.map.height);while(this.map.tiles[t][e]==="wall");this.player?(this.player.x=e,this.player.y=t):this.player=new b(e,t,this.playerClass),this.enemies=[],this.items=[];for(let s=0;s<6;s++){let i,r;do i=Math.floor(Math.random()*this.map.width),r=Math.floor(Math.random()*this.map.height);while(this.map.tiles[r][i]==="wall"||i===e&&r===t);const o=Math.random();let l="goblin";o<.2?l="bat":o<.4?l="shaman":o<.5?l="orc":o<.65?l="skeleton":o<.7&&(l="ogre"),this.enemies.push(new g(i,r,l))}for(let s=0;s<4;s++){let i,r;do i=Math.floor(Math.random()*this.map.width),r=Math.floor(Math.random()*this.map.height);while(this.map.tiles[r][i]==="wall");const o=Math.random();if(o<.4)this.items.push(new T(i,r));else if(o<.5)this.items.push(new S(i,r));else if(o<.6)this.items.push(new E(i,r));else if(o<.8){const l=Math.min(4,Math.floor(this.player.level/2)+1);this.items.push(new k(i,r,l))}else{const l=Math.min(4,Math.floor(this.player.level/2)+1);this.items.push(new I(i,r,l))}}}this.updateFOV(),this.log(`Entered Level ${this.player.level}`,"important")}handleInput(e){if(this.gameState==="GAMEOVER"||this.gameState==="VICTORY"){(e.key==="Enter"||e.key==="r")&&this.restart();return}if(!this.isPlayerTurn)return;const t=this.inputHandler.handleKey(e);if(t)if(t.type==="move"){const s=this.player.x+t.dx,i=this.player.y+t.dy,r=this.enemies.find(o=>o.x===s&&o.y===i);if(r)this.attackEnemy(r),this.isPlayerTurn=!1,this.update(),setTimeout(()=>this.enemyTurn(),100);else if(this.map.tiles[i][s]==="door_closed"){const l=this.player.inventory.findIndex(a=>a.name==="Golden Key");l!==-1?(this.log("You unlock the door with your key.","success"),this.map.tiles[i][s]="door_open",this.player.inventory.splice(l,1),this.updateUI(),this.audio.playPickup(),this.isPlayerTurn=!1,this.update(),setTimeout(()=>this.enemyTurn(),100)):this.log("The door is locked. You need a key.","warning")}else this.player.move(t.dx,t.dy,this.map)&&(this.audio.playFootstep(),this.updateFOV(),this.isPlayerTurn=!1,this.update(),setTimeout(()=>this.enemyTurn(),100))}else t.type==="interact"?this.checkStairs():t.type==="pickup"?this.pickupItem():t.type==="inventory"?this.toggleInventory():t.type}pickupItem(){const e=this.items.findIndex(t=>t.x===this.player.x&&t.y===this.player.y);if(e!==-1){const t=this.items[e];this.player.inventory.push(t),this.items.splice(e,1),this.log(`Picked up ${t.name}`,"pickup"),this.audio.playPickup(),this.updateUI()}else this.log("Nothing to pick up here.","warning")}toggleInventory(){const e=document.getElementById("inventory");e.style.display==="none"||!e.style.display?(e.style.display="block",this.renderInventory()):e.style.display="none"}renderInventory(){const e=document.getElementById("inventory-list");if(e.innerHTML="",this.player.inventory.length===0){e.innerHTML="<li>Empty</li>";return}this.player.inventory.forEach((t,s)=>{const i=document.createElement("li");i.innerText=`${s+1}. ${t.name}`,i.onclick=()=>this.useItem(s),e.appendChild(i)})}useItem(e){const t=this.player.inventory[e];if(t instanceof q){this.gameState="VICTORY",document.getElementById("victory-screen").style.display="flex",this.audio.playLevelUp();return}if(t){let s=!1;t.use(this.player,this)&&(s=!0),s?(this.log(`Used/Equipped ${t.name}`,"action"),this.player.inventory.splice(e,1),this.renderInventory(),this.updateUI(),this.isPlayerTurn=!1,setTimeout(()=>this.enemyTurn(),100)):this.log(`Cannot use ${t.name} right now.`,"warning")}}checkStairs(){this.map.tiles[this.player.y][this.player.x]==="stairs"?(this.player.level++,this.generateLevel(),this.update()):this.log("There are no stairs here.","warning")}enemyTurn(){this.enemies.forEach(e=>{e.takeTurn(this.player,this.map,t=>{if(t==="magic")this.log(`${e.char} casts a spell on you for 10 dmg!`,"danger"),this.player.hp-=10,this.renderer.triggerEffect(this.player.x,this.player.y,"hit");else if(t==="firebreath")this.log(`${e.char} breathes FIRE on you for 25 dmg!`,"danger"),this.player.hp-=25,this.renderer.triggerEffect(this.player.x,this.player.y,"hit");else{const s=this.combatSystem.resolveAttack(e,this.player);s.hit?(this.log(`${e.char} hits you for ${s.damage} dmg!`,"danger"),this.renderer.triggerEffect(this.player.x,this.player.y,"hit")):(this.log(`${e.char} misses you!`,"info"),this.audio.playMiss())}})}),this.isPlayerTurn=!0,this.update()}attackEnemy(e){const t=this.combatSystem.resolveAttack(this.player,e);t.hit?(this.log(`You hit ${e.char} for ${t.damage} dmg!`,"combat"),this.audio.playAttack(),this.renderer.triggerEffect(e.x,e.y,"hit"),t.killed&&(this.log(`${e.char} dies! +10 XP`,"success"),this.player.gainXp(10),this.audio.playHit(),this.enemies=this.enemies.filter(s=>s!==e))):(this.log(`You miss ${e.char}!`,"info"),this.audio.playMiss())}update(){this.draw(),this.updateUI(),this.player.hp<=0&&this.gameState!=="GAMEOVER"&&(this.gameState="GAMEOVER",document.getElementById("game-over").style.display="flex",this.log("You have died...","important"))}log(e,t="info"){const s=document.getElementById("log"),i=document.createElement("div");i.classList.add("log-entry"),t&&i.classList.add(t),i.innerText=e,s.prepend(i),s.children.length>50&&s.removeChild(s.lastChild)}loop(){requestAnimationFrame(()=>this.loop()),this.draw()}draw(){this.renderer.clear(),this.renderer.drawMap(this.map,this.visibleTiles,this.exploredTiles),this.items.forEach(e=>{this.renderer.drawEntity(e,this.visibleTiles)}),this.enemies.forEach(e=>{this.renderer.drawEntity(e,this.visibleTiles)}),this.renderer.drawEntity(this.player,this.visibleTiles)}updateUI(){document.getElementById("hp-val").innerText=`${this.player.hp}/${this.player.maxHp}`,document.getElementById("lvl-val").innerText=this.player.level,document.getElementById("atk-val").innerText=this.player.getAttack(),document.getElementById("def-val").innerText=this.player.getDefense(),document.getElementById("weapon-val").innerText=this.player.equipment.weapon?this.player.equipment.weapon.name:"None",document.getElementById("armor-val").innerText=this.player.equipment.armor?this.player.equipment.armor.name:"None"}restart(){location.reload()}}console.log("Main.js loaded");window.addEventListener("DOMContentLoaded",()=>{const h=document.getElementById("gameCanvas");new N(h).init()});
