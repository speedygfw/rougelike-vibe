(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();class q{constructor(e){this.canvas=e,this.ctx=e.getContext("2d"),this.tileSize=32,this.effects=[],this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight}clear(){this.ctx.fillStyle="#111",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}drawMap(e,t,s){this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let i=0;i<e.height;i++)for(let r=0;r<e.width;r++){const o=`${r},${i}`,n=t.has(o);if(!s.has(o)&&!n)continue;const c=e.tiles[i][r],h=r*this.tileSize,u=i*this.tileSize;this.ctx.globalAlpha=n?1:.3,this.ctx.font=`${this.tileSize}px monospace`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",c==="wall"?(this.ctx.fillStyle="#444",this.ctx.fillRect(h,u,this.tileSize,this.tileSize),this.ctx.fillStyle="#666",this.ctx.fillText("üß±",h+this.tileSize/2,u+this.tileSize/2)):c==="floor"?(this.ctx.fillStyle="#222",this.ctx.fillRect(h,u,this.tileSize,this.tileSize),this.ctx.fillStyle="#333",this.ctx.fillText("¬∑",h+this.tileSize/2,u+this.tileSize/2)):c==="stairs"&&(this.ctx.fillStyle="#222",this.ctx.fillRect(h,u,this.tileSize,this.tileSize),this.ctx.fillStyle="#ffff00",this.ctx.fillText("ü™ú",h+this.tileSize/2,u+this.tileSize/2))}this.ctx.globalAlpha=1}drawEntity(e,t){if(!t){console.error("visibleTiles is undefined in drawEntity");return}if(!t.has(`${e.x},${e.y}`))return;const s=this.tileSize;this.ctx.font=`${s*.8}px sans-serif`,this.ctx.textAlign="center",this.ctx.textBaseline="middle";let i=e.char;e.constructor.name==="Player"?i="üßô‚Äç‚ôÇÔ∏è":e.constructor.name==="Potion"?i="üç∑":e.constructor.name==="Weapon"?i="üó°Ô∏è":e.constructor.name==="Armor"?i="üõ°Ô∏è":e.type==="bat"?i="ü¶á":e.type==="orc"?i="üëπ":e.type==="shaman"?i="üë∫":e.type==="goblin"?i="üëø":e.type==="skeleton"?i="üíÄ":e.type==="ogre"&&(i="üëπ"),this.ctx.fillStyle="rgba(0,0,0,0.5)",this.ctx.fillText(i,e.x*s+s/2+2,e.y*s+s/2+2),this.ctx.fillStyle=e.color||"#fff",this.ctx.fillText(i,e.x*s+s/2,e.y*s+s/2)}triggerEffect(e,t,s){this.effects.push({x:e,y:t,type:s,life:20})}drawEffects(){for(let e=this.effects.length-1;e>=0;e--){const t=this.effects[e],s=t.x*this.tileSize,i=t.y*this.tileSize;t.type==="hit"&&(this.ctx.fillStyle=`rgba(255, 0, 0, ${t.life/20})`,this.ctx.fillRect(s,i,this.tileSize,this.tileSize)),t.life--,t.life<=0&&this.effects.splice(e,1)}}}class O{constructor(e,t){this.width=e,this.height=t,this.rooms=[]}generate(){const e={width:this.width,height:this.height,tiles:[],rooms:[]};for(let r=0;r<this.height;r++){const o=[];for(let n=0;n<this.width;n++)o.push("wall");e.tiles.push(o)}this.rooms=[];const t=10,s=6,i=12;for(let r=0;r<t;r++){const o=Math.floor(Math.random()*(i-s+1))+s,n=Math.floor(Math.random()*(i-s+1))+s,a=Math.floor(Math.random()*(this.width-o-1))+1,c=Math.floor(Math.random()*(this.height-n-1))+1,h={x:a,y:c,w:o,h:n};let u=!1;for(const p of this.rooms)if(h.x<=p.x+p.w&&h.x+h.w>=p.x&&h.y<=p.y+p.h&&h.y+h.h>=p.y){u=!0;break}if(!u){if(this.createRoom(h,e),this.rooms.length>0){const p=this.rooms[this.rooms.length-1],m=this.getCenter(h),f=this.getCenter(p);Math.random()<.5?(this.createHCorridor(f.x,m.x,f.y,e),this.createVCorridor(f.y,m.y,m.x,e)):(this.createVCorridor(f.y,m.y,f.x,e),this.createHCorridor(f.x,m.x,m.y,e))}this.rooms.push(h),e.rooms.push(h)}}if(this.rooms.length>0){const r=this.rooms[this.rooms.length-1],o=this.getCenter(r);e.tiles[o.y][o.x]="stairs"}return e}createRoom(e,t){for(let s=e.y;s<e.y+e.h;s++)for(let i=e.x;i<e.x+e.w;i++)t.tiles[s][i]="floor"}createHCorridor(e,t,s,i){for(let r=Math.min(e,t);r<=Math.max(e,t);r++)i.tiles[s][r]="floor"}createVCorridor(e,t,s,i){for(let r=Math.min(e,t);r<=Math.max(e,t);r++)i.tiles[r][s]="floor"}getCenter(e){return{x:Math.floor(e.x+e.w/2),y:Math.floor(e.y+e.h/2)}}}class S{constructor(e,t,s,i){this.x=e,this.y=t,this.char=s,this.color=i}move(e,t,s){const i=this.x+e,r=this.y+t;return i>=0&&i<s.width&&r>=0&&r<s.height&&s.tiles[r][i]!=="wall"?(this.x=i,this.y=r,!0):!1}}class T extends S{constructor(e,t){super(e,t,"@","#fff"),this.hp=100,this.maxHp=100,this.level=1,this.xp=0,this.xpToNextLevel=100,this.inventory=[],this.equipment={weapon:null,armor:null}}gainXp(e){this.xp+=e,this.xp>=this.xpToNextLevel&&this.levelUp()}levelUp(){this.level++,this.xp-=this.xpToNextLevel,this.xpToNextLevel=Math.floor(this.xpToNextLevel*1.5),this.maxHp+=20,this.hp=this.maxHp}equip(e){return e.slot==="weapon"?(this.equipment.weapon&&this.inventory.push(this.equipment.weapon),this.equipment.weapon=e,!0):e.slot==="armor"?(this.equipment.armor&&this.inventory.push(this.equipment.armor),this.equipment.armor=e,!0):!1}getAttack(){let e=5+this.level*2;return this.equipment.weapon&&(e+=this.equipment.weapon.bonus),e}getDefense(){let e=0;return this.equipment.armor&&(e+=this.equipment.armor.bonus),e}}class x extends S{constructor(e,t,s="goblin"){let i="g",r="#ff4444",o=20;s==="bat"?(i="b",r="#a8a8a8",o=10):s==="orc"?(i="O",r="#00aa00",o=40):s==="shaman"?(i="S",r="#aa00aa",o=15):s==="skeleton"?(i="üíÄ",r="#dddddd",o=12):s==="ogre"?(i="üëπ",r="#006600",o=60):s==="dragon"&&(i="üêâ",r="#ff0000",o=150),super(e,t,i,r),this.type=s,this.hp=o}getAttack(){return this.type==="bat"?2:this.type==="goblin"?5:this.type==="shaman"?4:this.type==="orc"?8:this.type==="skeleton"?4:this.type==="ogre"?12:this.type==="dragon"?20:3}getDefense(){return this.type==="bat"?0:this.type==="goblin"||this.type==="shaman"?1:this.type==="orc"?3:this.type==="skeleton"?1:this.type==="ogre"?4:this.type==="dragon"?8:0}takeTurn(e,t,s){const i=e.x-this.x,r=e.y-this.y,o=Math.abs(i)+Math.abs(r);if(this.type==="bat")for(let n=0;n<2;n++){if(Math.random()<.3){const a=[[0,1],[0,-1],[1,0],[-1,0]],c=a[Math.floor(Math.random()*a.length)];this.tryMove(c[0],c[1],t,e,s)}else this.moveTowards(e,t,s);if(Math.abs(e.x-this.x)+Math.abs(e.y-this.y)<=1)break}else if(this.type==="shaman")if(o<=4)if(o<=2){let n=0,a=0;i!==0&&(n=i>0?-1:1),r!==0&&(a=r>0?-1:1),this.tryMove(n,a,t,e,null)}else s&&s("magic");else this.moveTowards(e,t,s);else this.type==="dragon"?(i===0||r===0)&&o<=5?s&&s("firebreath"):this.moveTowards(e,t,s):this.type==="ogre"?this.moveTowards(e,t,s):this.moveTowards(e,t,s)}moveTowards(e,t,s){const i=e.x-this.x,r=e.y-this.y;let o=0,n=0;Math.abs(i)>Math.abs(r)?o=i>0?1:-1:n=r>0?1:-1,this.tryMove(o,n,t,e,s)}tryMove(e,t,s,i,r){const o=this.x+e,n=this.y+t;if(o===i.x&&n===i.y){r&&r("melee");return}this.move(e,t,s)}}class w extends S{constructor(e,t,s,i,r){super(e,t,i,r),this.name=s}}class k extends w{constructor(e,t){super(e,t,"Health Potion","!","#ff00ff"),this.healAmount=20}use(e){return e.hp>=e.maxHp?!1:(e.hp=Math.min(e.hp+this.healAmount,e.maxHp),!0)}}class A extends w{constructor(e,t,s,i,r){super(e,t,s,"üìú",i),this.effectType=r}use(e,t){return this.activate(e,t)}activate(e,t){return!1}}class I extends A{constructor(e,t){super(e,t,"Scroll of Fireball","#ff4400","fireball"),this.damage=20,this.range=5}activate(e,t){let s=0;return t.enemies.forEach(i=>{Math.abs(i.x-e.x)+Math.abs(i.y-e.y)<=this.range&&(i.hp-=this.damage,t.log(`Fireball burns ${i.type} for ${this.damage} dmg!`,"combat"),t.renderer.triggerEffect(i.x,i.y,"hit"),s++)}),s>0?(t.enemies=t.enemies.filter(i=>i.hp<=0?(t.log(`${i.type} is incinerated! +${i.xpValue||10} XP`,"success"),e.gainXp(i.xpValue||10),!1):!0),!0):(t.log("No enemies in range to burn.","warning"),!1)}}class C extends A{constructor(e,t){super(e,t,"Scroll of Teleport","#00ffff","teleport")}activate(e,t){let s,i,r=0;do s=Math.floor(Math.random()*t.map.width),i=Math.floor(Math.random()*t.map.height),r++;while((t.map.tiles[i][s]==="wall"||s===e.x&&i===e.y)&&r<100);return t.map.tiles[i][s]!=="wall"?(e.x=s,e.y=i,t.log("You teleport to a new location!","magic"),t.updateFOV(),!0):!1}}class M extends w{constructor(e,t){super(e,t,"Amulet of Yendor","üìø","#ffd700")}use(e,t){return!0}}class R extends w{constructor(e,t,s,i,r,o,n){super(e,t,s,i,r),this.slot=o,this.bonus=n}use(e){return e.equip(this)}}class L extends R{constructor(e,t,s=1){const i=[{name:"Rusty Dagger",bonus:2,color:"#888"},{name:"Iron Sword",bonus:5,color:"#ddd"},{name:"Steel Axe",bonus:8,color:"#aaf"},{name:"Mithril Blade",bonus:12,color:"#0ff"}],r=i[Math.min(s,i.length)-1];super(e,t,r.name,"üó°Ô∏è",r.color,"weapon",r.bonus)}}class $ extends R{constructor(e,t,s=1){const i=[{name:"Tattered Robe",bonus:1,color:"#a88"},{name:"Leather Armor",bonus:3,color:"#a52"},{name:"Chainmail",bonus:6,color:"#aaa"},{name:"Plate Armor",bonus:10,color:"#eee"}],r=i[Math.min(s,i.length)-1];super(e,t,r.name,"üõ°Ô∏è",r.color,"armor",r.bonus)}}class z{constructor(e){this.map=e,this.visible=new Set}compute(e,t,s){this.visible.clear(),this.visible.add(`${e},${t}`);for(let i=0;i<8;i++)this.castLight(e,t,1,1,0,s,this.multipliers[0][i],this.multipliers[1][i],this.multipliers[2][i],this.multipliers[3][i]);return this.visible}castLight(e,t,s,i,r,o,n,a,c,h){if(i<r)return;let u=o*o;for(let p=s;p<=o;p++){let m=-p-1,f=-p,g=!1,v=0;for(;m<=0;){m++;let d=e+m*n+f*a,y=t+m*c+f*h,E=(m-.5)/(f+.5),b=(m+.5)/(f-.5);if(!(i<b)){if(r>E)break;if(m*m+f*f<u&&d>=0&&d<this.map.width&&y>=0&&y<this.map.height&&this.visible.add(`${d},${y}`),g)if(this.isBlocked(d,y)){v=b;continue}else g=!1,i=v;else this.isBlocked(d,y)&&p<o&&(g=!0,this.castLight(e,t,p+1,i,E,o,n,a,c,h),v=b)}}if(g)break}}isBlocked(e,t){return e<0||e>=this.map.width||t<0||t>=this.map.height?!0:this.map.tiles[t][e]==="wall"}multipliers=[[1,0,0,-1,-1,0,0,1],[0,1,-1,0,0,-1,1,0],[0,1,1,0,0,-1,-1,0],[1,0,0,1,-1,0,0,-1]]}class P{constructor(){this.ctx=new(window.AudioContext||window.webkitAudioContext)}playTone(e,t,s){this.ctx.state==="suspended"&&this.ctx.resume();const i=this.ctx.createOscillator(),r=this.ctx.createGain();i.type=t,i.frequency.setValueAtTime(e,this.ctx.currentTime),r.gain.setValueAtTime(.1,this.ctx.currentTime),r.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+s),i.connect(r),r.connect(this.ctx.destination),i.start(),i.stop(this.ctx.currentTime+s)}playAttack(){this.playTone(150,"square",.1)}playHit(){this.playTone(100,"sawtooth",.1)}playPickup(){this.playTone(600,"sine",.1)}playLevelUp(){this.playTone(400,"sine",.1),setTimeout(()=>this.playTone(600,"sine",.1),100),setTimeout(()=>this.playTone(800,"sine",.2),200)}playFootstep(){this.playTone(100,"triangle",.05)}playMiss(){this.playTone(800,"sawtooth",.05)}}class G{constructor(){this.command=null}handleKey(e){return this.command=null,e.key==="ArrowUp"||e.key==="w"?{type:"move",dx:0,dy:-1}:e.key==="ArrowDown"||e.key==="s"?{type:"move",dx:0,dy:1}:e.key==="ArrowLeft"||e.key==="a"?{type:"move",dx:-1,dy:0}:e.key==="ArrowRight"||e.key==="d"?{type:"move",dx:1,dy:0}:e.key==="Enter"||e.key===" "?{type:"interact"}:e.key==="g"?{type:"pickup"}:e.key==="i"?{type:"inventory"}:e.key==="r"?{type:"restart"}:null}}class H{constructor(e){this.game=e}resolveAttack(e,t){if(Math.random()>.8)return{hit:!1,damage:0,killed:!1,attacker:e,defender:t};const s=e.getAttack(),i=t.getDefense?t.getDefense():0,r=Math.max(1,s-i);return t.hp-=r,{hit:!0,damage:r,killed:t.hp<=0,attacker:e,defender:t}}}class V{constructor(e){this.renderer=new q(e),this.audio=new P,this.inputHandler=new G,this.combatSystem=new H(this),this.mapGenerator=new O(50,30),this.map=null,this.player=null,this.enemies=[],this.items=[],this.isPlayerTurn=!0,this.fov=null,this.visibleTiles=new Set,this.exploredTiles=new Set,this.fovRadius=8,this.gameState="PLAYING",this.createSaveControls()}createSaveControls(){const e=document.createElement("div");e.style.position="absolute",e.style.top="10px",e.style.right="10px",e.style.zIndex="100";const t=document.createElement("button");t.innerText="Save",t.onclick=()=>this.saveGame();const s=document.createElement("button");s.innerText="Load",s.onclick=()=>this.loadGame(),e.appendChild(t),e.appendChild(s),document.body.appendChild(e)}saveGame(){const e={map:this.map,player:{x:this.player.x,y:this.player.y,hp:this.player.hp,maxHp:this.player.maxHp,level:this.player.level,xp:this.player.xp,xpToNextLevel:this.player.xpToNextLevel,inventory:this.player.inventory,equipment:this.player.equipment},enemies:this.enemies.map(t=>({x:t.x,y:t.y,hp:t.hp,type:t.type})),items:this.items,level:this.player.level,exploredTiles:Array.from(this.exploredTiles)};localStorage.setItem("roguelike_save",JSON.stringify(e)),this.log("Game Saved!","success")}loadGame(){const e=localStorage.getItem("roguelike_save");if(!e){this.log("No save game found.","warning");return}const t=JSON.parse(e);this.map=t.map,this.mapGenerator.width=this.map.width,this.mapGenerator.height=this.map.height,this.player=new T(t.player.x,t.player.y),Object.assign(this.player,t.player),this.player.inventory=t.player.inventory.map(s=>this.hydrateItem(s)),this.player.equipment.weapon&&(this.player.equipment.weapon=this.hydrateItem(this.player.equipment.weapon)),this.player.equipment.armor&&(this.player.equipment.armor=this.hydrateItem(this.player.equipment.armor)),this.enemies=t.enemies.map(s=>{const i=new x(s.x,s.y,s.type);return i.hp=s.hp,i}),this.items=t.items.map(s=>this.hydrateItem(s)),this.exploredTiles=new Set(t.exploredTiles),this.fov=new z(this.map),this.updateFOV(),this.log("Game Loaded!","success"),this.update()}hydrateItem(e){if(!e)return null;if(e.slot){if(e.slot==="weapon")return new L(e.x,e.y,e.bonus<5?1:e.bonus<8?2:3);if(e.slot==="armor")return new $(e.x,e.y,e.bonus<3?1:e.bonus<6?2:3)}return e.name.includes("Potion")?new k(e.x,e.y):e.name.includes("Fireball")?new I(e.x,e.y):e.name.includes("Teleport")?new C(e.x,e.y):e.name.includes("Amulet")?new M(e.x,e.y):e}start(){this.init(),this.loop()}init(){this.generateLevel(),window.addEventListener("keydown",e=>this.handleInput(e)),document.getElementById("restart-btn-go").onclick=()=>this.restart(),document.getElementById("restart-btn-vic").onclick=()=>this.restart(),this.update()}generateLevel(){if(this.map=this.mapGenerator.generate(),this.fov=new z(this.map),this.exploredTiles.clear(),this.map.rooms&&this.map.rooms.length>0){const e=this.map.rooms[0],t=this.mapGenerator.getCenter(e);if(this.player?(this.player.x=t.x,this.player.y=t.y):this.player=new T(t.x,t.y),this.enemies=[],this.items=[],this.player.level===10){const s=this.mapGenerator.getCenter(this.map.rooms[this.map.rooms.length-1]);this.enemies.push(new x(s.x,s.y,"dragon"));const i=this.mapGenerator.getCenter(this.map.rooms[Math.floor(this.map.rooms.length/2)]);this.items.push(new M(i.x,i.y)),this.log("You feel an ominous presence... The Dragon awaits!","important")}else{for(let s=1;s<this.map.rooms.length;s++){const i=this.map.rooms[s],r=this.mapGenerator.getCenter(i);if(Math.random()<.7){const o=Math.random();let n="goblin";o<.2?n="bat":o<.4?n="shaman":o<.5?n="orc":o<.65?n="skeleton":o<.7&&(n="ogre"),this.enemies.push(new x(r.x,r.y,n))}if(Math.random()<.6){const o=Math.floor(Math.random()*i.w)+i.x,n=Math.floor(Math.random()*i.h)+i.y;if(this.map.tiles[n][o]==="floor"){const a=Math.random();if(a<.4)this.items.push(new k(o,n));else if(a<.5)this.items.push(new I(o,n));else if(a<.6)this.items.push(new C(o,n));else if(a<.8){const c=Math.min(4,Math.floor(this.player.level/2)+1);this.items.push(new L(o,n,c))}else{const c=Math.min(4,Math.floor(this.player.level/2)+1);this.items.push(new $(o,n,c))}}}}for(;this.enemies.length<3;){let s,i;do s=Math.floor(Math.random()*this.map.width),i=Math.floor(Math.random()*this.map.height);while(this.map.tiles[i][s]==="wall");this.enemies.push(new x(s,i))}}}else{let e,t;do e=Math.floor(Math.random()*this.map.width),t=Math.floor(Math.random()*this.map.height);while(this.map.tiles[t][e]==="wall");this.player?(this.player.x=e,this.player.y=t):this.player=new T(e,t),this.enemies=[],this.items=[]}this.updateFOV(),this.log(`Entered Level ${this.player.level}`,"important")}updateFOV(){this.visibleTiles=this.fov.compute(this.player.x,this.player.y,this.fovRadius),this.visibleTiles.forEach(e=>this.exploredTiles.add(e))}handleInput(e){if(this.gameState==="GAMEOVER"||this.gameState==="VICTORY"){(e.key==="Enter"||e.key==="r")&&this.restart();return}if(!this.isPlayerTurn)return;const t=this.inputHandler.handleKey(e);if(t)if(t.type==="move"){const s=this.player.x+t.dx,i=this.player.y+t.dy,r=this.enemies.find(o=>o.x===s&&o.y===i);r?(this.attackEnemy(r),this.isPlayerTurn=!1,this.update(),setTimeout(()=>this.enemyTurn(),100)):this.player.move(t.dx,t.dy,this.map)&&(this.audio.playFootstep(),this.updateFOV(),this.isPlayerTurn=!1,this.update(),setTimeout(()=>this.enemyTurn(),100))}else t.type==="interact"?this.checkStairs():t.type==="pickup"?this.pickupItem():t.type==="inventory"?this.toggleInventory():t.type}pickupItem(){const e=this.items.findIndex(t=>t.x===this.player.x&&t.y===this.player.y);if(e!==-1){const t=this.items[e];this.player.inventory.push(t),this.items.splice(e,1),this.log(`Picked up ${t.name}`,"pickup"),this.audio.playPickup(),this.updateUI()}else this.log("Nothing to pick up here.","warning")}toggleInventory(){const e=document.getElementById("inventory");e.style.display==="none"||!e.style.display?(e.style.display="block",this.renderInventory()):e.style.display="none"}renderInventory(){const e=document.getElementById("inventory-list");if(e.innerHTML="",this.player.inventory.length===0){e.innerHTML="<li>Empty</li>";return}this.player.inventory.forEach((t,s)=>{const i=document.createElement("li");i.innerText=`${s+1}. ${t.name}`,i.onclick=()=>this.useItem(s),e.appendChild(i)})}useItem(e){const t=this.player.inventory[e];if(t instanceof M){this.gameState="VICTORY",document.getElementById("victory-screen").style.display="flex",this.audio.playLevelUp();return}if(t){let s=!1;t.use(this.player,this)&&(s=!0),s?(this.log(`Used/Equipped ${t.name}`,"action"),this.player.inventory.splice(e,1),this.renderInventory(),this.updateUI(),this.isPlayerTurn=!1,setTimeout(()=>this.enemyTurn(),100)):this.log(`Cannot use ${t.name} right now.`,"warning")}}checkStairs(){this.map.tiles[this.player.y][this.player.x]==="stairs"?(this.player.level++,this.generateLevel(),this.update()):this.log("There are no stairs here.","warning")}enemyTurn(){this.enemies.forEach(e=>{e.takeTurn(this.player,this.map,t=>{if(t==="magic")this.log(`${e.char} casts a spell on you for 10 dmg!`,"danger"),this.player.hp-=10,this.renderer.triggerEffect(this.player.x,this.player.y,"hit");else if(t==="firebreath")this.log(`${e.char} breathes FIRE on you for 25 dmg!`,"danger"),this.player.hp-=25,this.renderer.triggerEffect(this.player.x,this.player.y,"hit");else{const s=this.combatSystem.resolveAttack(e,this.player);s.hit?(this.log(`${e.char} hits you for ${s.damage} dmg!`,"danger"),this.renderer.triggerEffect(this.player.x,this.player.y,"hit")):(this.log(`${e.char} misses you!`,"info"),this.audio.playMiss())}})}),this.isPlayerTurn=!0,this.update()}attackEnemy(e){const t=this.combatSystem.resolveAttack(this.player,e);t.hit?(this.log(`You hit ${e.char} for ${t.damage} dmg!`,"combat"),this.audio.playAttack(),this.renderer.triggerEffect(e.x,e.y,"hit"),t.killed&&(this.log(`${e.char} dies! +10 XP`,"success"),this.player.gainXp(10),this.audio.playHit(),this.enemies=this.enemies.filter(s=>s!==e))):(this.log(`You miss ${e.char}!`,"info"),this.audio.playMiss())}update(){this.draw(),this.updateUI(),this.player.hp<=0&&this.gameState!=="GAMEOVER"&&(this.gameState="GAMEOVER",document.getElementById("game-over").style.display="flex",this.log("You have died...","important"))}log(e,t="info"){const s=document.getElementById("log"),i=document.createElement("div");i.classList.add("log-entry"),t&&i.classList.add(t),i.innerText=e,s.prepend(i),s.children.length>50&&s.removeChild(s.lastChild)}loop(){requestAnimationFrame(()=>this.loop()),this.draw()}draw(){this.renderer.clear(),this.renderer.drawMap(this.map,this.visibleTiles,this.exploredTiles),this.items.forEach(e=>{this.renderer.drawEntity(e,this.visibleTiles)}),this.enemies.forEach(e=>{this.renderer.drawEntity(e,this.visibleTiles)}),this.renderer.drawEntity(this.player,this.visibleTiles)}updateUI(){document.getElementById("hp-val").innerText=`${this.player.hp}/${this.player.maxHp}`,document.getElementById("lvl-val").innerText=this.player.level}restart(){location.reload()}}console.log("Main.js loaded");window.addEventListener("DOMContentLoaded",()=>{const l=document.getElementById("gameCanvas");new V(l).start()});
